#!/usr/bin/python
'''
Date : 1402/01/12
Author : AmirhosseinKhanshabani - @AmirZoyber

Making Data Searchable
    1. Create a database
    2. Create a table
    3. Insert data into the table
    4. Query the table

Post analysis with text data is difficult
store in database - indexed and searchable
sqlite is a great option

'''

# sqlite configs
'''
sqlite probes.db
create table clients (
    id integer primary key autoincrement,
    location char(100) not null,
    macaddr char(50) not null,
    probed_ssid text not null);
.tables    # show tables -> clients
.schema    # show schema -> CREATE TABLE clients (id integer primary key autoincrement, location char(100) not null, macaddr char(50) not null, probed_ssid text not null);

ctrl + c  # exit


'''

import sys
from scapy.all import *
import sqlite3

clientProbes = set()

def InsertintoDB(mac,ssid):
    connection.execute("INSERT INTO PROBES (MAC,SSID) VALUES (?,?)",(mac,ssid))
    connection.commit()

def PacketHandler(pkt):
    if pkt.haslayer(Dot11ProbeReq):
        if (len(pkt.info)>0):
            testcase = pkt.addr2 +"---"+ pkt.info
            if testcase not in clientProbes:
                clientProbes.add(testcase)
                print(f"New Probe Found : {len(clientProbes)}, {pkt.addr2}, {pkt.info}")
                
                print("\n---------Client Proces Table---------")
                counter = 1
                for probe in clientProbes:
                    [client, ssid] = probe.split("---")
                    print(f"{client} : {ssid}")
                    counter+=1
                    InsertintoDB(pkt.addr2,pkt.info)
                print("\n--------------------------------------\n")

connection = sqlite3.connect(sys.argv[3])
sniff(iface=sys.argv[1], count=int(sys.argv[2]), prn = PacketHandler)
connection.close()

# python3 FromPacketsToDB.py wlan0 1000 probes.db office
